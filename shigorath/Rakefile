require 'yaml'

namespace :shig do

  def images_to_build(environment)
    settings = YAML::load(File.open("#{environment}/docker-compose.yml"))
    settings.map{|name, params| params.has_key?('build')? name:nil}.compact
  end

  desc 'Basic deploy of staging images'
  task :staging_deploy do
    deploy_timestamp = Time.now.to_i
    images_to_build('staging').each do |image|
      tagged_image = "104.131.124.150:5000/staging_#{image}:#{deploy_timestamp}"
      sh "docker tag staging_#{image}:latest #{tagged_image}"
      sh "docker push #{tagged_image}"
    end
  end

  desc 'Copy dockerfiles to application root'
  task :copy_dockerfiles_to_root do
    images_to_build('staging').each do |image|
      cp "staging/#{image}/Dockerfile", "../#{image}.dockerfile"   
    end
  end 

  desc 'Remove copied dockerfiles from application context'
  task :remove_dockerfiles_from_root do
    images_to_build('staging').each do |image|
      rm "../#{image}.dockerfile"
    end
  end

  desc 'Build local staging'
  task :build_local_staging => [:copy_dockerfiles_to_root] do
    Dir.chdir('../') do
      sh 'docker-compose -f shigorath/staging/docker-compose.yml build'
    end
    Rake::Task["shig:remove_dockerfiles_from_root"].invoke
  end
end
